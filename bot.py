from zoneinfo import ZoneInfo
import asyncio
import datetime
import aiohttp

TELEGRAM_BOT_TOKEN = "7858933900:AAH13QdgI1_xXJYt13tC2B9zRBIrlGuDJL8"
TELEGRAM_CHAT_ID = "582915868"

# –°–ª–æ–≤–∞—Ä—å —Å –≤—Ä–µ–º–µ–Ω–µ–º –Ω–∞–º–∞–∑–∞
PRAYER_TIMES = {
    "01-04-2025": {"–§–∞–¥–∂—Ä": "04:16", "–®—É—Ä—É–∫": "05:46", "–ó—É—Ö—Ä": "12:20", "–ê—Å—Ä": "15:54", "–ú–∞–≥—Ä–∏–±": "18:37", "–ò—à–∞": "20:17"},
    "02-04-2025": {"–§–∞–¥–∂—Ä": "04:14", "–®—É—Ä—É–∫": "05:44", "–ó—É—Ö—Ä": "12:19", "–ê—Å—Ä": "15:54", "–ú–∞–≥—Ä–∏–±": "18:37", "–ò—à–∞": "20:17"},
    "03-04-2025": {"–§–∞–¥–∂—Ä": "04:12", "–®—É—Ä—É–∫": "05:42", "–ó—É—Ö—Ä": "12:19", "–ê—Å—Ä": "15:55", "–ú–∞–≥—Ä–∏–±": "18:39", "–ò—à–∞": "20:19"},
    "04-04-2025": {"–§–∞–¥–∂—Ä": "04:10", "–®—É—Ä—É–∫": "05:40", "–ó—É—Ö—Ä": "12:19", "–ê—Å—Ä": "15:55", "–ú–∞–≥—Ä–∏–±": "18:40", "–ò—à–∞": "20:20"},
    "05-04-2025": {"–§–∞–¥–∂—Ä": "04:08", "–®—É—Ä—É–∫": "05:38", "–ó—É—Ö—Ä": "12:18", "–ê—Å—Ä": "15:56", "–ú–∞–≥—Ä–∏–±": "18:41", "–ò—à–∞": "20:21"},
    "06-04-2025": {"–§–∞–¥–∂—Ä": "04:07", "–®—É—Ä—É–∫": "05:37", "–ó—É—Ö—Ä": "12:18", "–ê—Å—Ä": "15:56", "–ú–∞–≥—Ä–∏–±": "18:43", "–ò—à–∞": "20:23"},
    "07-04-2025": {"–§–∞–¥–∂—Ä": "04:05", "–®—É—Ä—É–∫": "05:35", "–ó—É—Ö—Ä": "12:18", "–ê—Å—Ä": "15:56", "–ú–∞–≥—Ä–∏–±": "18:44", "–ò—à–∞": "20:24"},
    "08-04-2025": {"–§–∞–¥–∂—Ä": "04:03", "–®—É—Ä—É–∫": "05:33", "–ó—É—Ö—Ä": "12:18", "–ê—Å—Ä": "15:57", "–ú–∞–≥—Ä–∏–±": "18:45", "–ò—à–∞": "20:25"},
    "09-04-2025": {"–§–∞–¥–∂—Ä": "04:02", "–®—É—Ä—É–∫": "05:32", "–ó—É—Ö—Ä": "12:17", "–ê—Å—Ä": "15:57", "–ú–∞–≥—Ä–∏–±": "18:46", "–ò—à–∞": "20:26"},
    "10-04-2025": {"–§–∞–¥–∂—Ä": "04:00", "–®—É—Ä—É–∫": "05:30", "–ó—É—Ö—Ä": "12:17", "–ê—Å—Ä": "15:58", "–ú–∞–≥—Ä–∏–±": "18:47", "–ò—à–∞": "20:27"},
    "11-04-2025": {"–§–∞–¥–∂—Ä": "03:58", "–®—É—Ä—É–∫": "05:28", "–ó—É—Ö—Ä": "12:17", "–ê—Å—Ä": "15:58", "–ú–∞–≥—Ä–∏–±": "18:48", "–ò—à–∞": "20:28"},
    "12-04-2025": {"–§–∞–¥–∂—Ä": "03:56", "–®—É—Ä—É–∫": "05:26", "–ó—É—Ö—Ä": "12:16", "–ê—Å—Ä": "15:59", "–ú–∞–≥—Ä–∏–±": "18:50", "–ò—à–∞": "20:30"},
    "13-04-2025": {"–§–∞–¥–∂—Ä": "03:55", "–®—É—Ä—É–∫": "05:25", "–ó—É—Ö—Ä": "12:16", "–ê—Å—Ä": "16:00", "–ú–∞–≥—Ä–∏–±": "18:51", "–ò—à–∞": "20:31"},
    "14-04-2025": {"–§–∞–¥–∂—Ä": "03:53", "–®—É—Ä—É–∫": "05:23", "–ó—É—Ö—Ä": "12:16", "–ê—Å—Ä": "16:00", "–ú–∞–≥—Ä–∏–±": "18:52", "–ò—à–∞": "20:32"},
    "15-04-2025": {"–§–∞–¥–∂—Ä": "03:51", "–®—É—Ä—É–∫": "05:21", "–ó—É—Ö—Ä": "12:16", "–ê—Å—Ä": "16:00", "–ú–∞–≥—Ä–∏–±": "18:53", "–ò—à–∞": "20:33"},
    "16-04-2025": {"–§–∞–¥–∂—Ä": "03:50", "–®—É—Ä—É–∫": "05:20", "–ó—É—Ö—Ä": "12:16", "–ê—Å—Ä": "16:00", "–ú–∞–≥—Ä–∏–±": "18:54", "–ò—à–∞": "20:34"},
    "17-04-2025": {"–§–∞–¥–∂—Ä": "03:48", "–®—É—Ä—É–∫": "05:18", "–ó—É—Ö—Ä": "12:15", "–ê—Å—Ä": "16:01", "–ú–∞–≥—Ä–∏–±": "18:56", "–ò—à–∞": "20:36"},
    "18-04-2025": {"–§–∞–¥–∂—Ä": "03:46", "–®—É—Ä—É–∫": "05:16", "–ó—É—Ö—Ä": "12:15", "–ê—Å—Ä": "16:01", "–ú–∞–≥—Ä–∏–±": "18:57", "–ò—à–∞": "20:37"},
    "19-04-2025": {"–§–∞–¥–∂—Ä": "03:45", "–®—É—Ä—É–∫": "05:15", "–ó—É—Ö—Ä": "12:15", "–ê—Å—Ä": "16:02", "–ú–∞–≥—Ä–∏–±": "18:58", "–ò—à–∞": "20:38"},
    "20-04-2025": {"–§–∞–¥–∂—Ä": "03:43", "–®—É—Ä—É–∫": "05:13", "–ó—É—Ö—Ä": "12:15", "–ê—Å—Ä": "16:02", "–ú–∞–≥—Ä–∏–±": "18:59", "–ò—à–∞": "20:39"},
    "21-04-2025": {"–§–∞–¥–∂—Ä": "03:42", "–®—É—Ä—É–∫": "05:12", "–ó—É—Ö—Ä": "12:14", "–ê—Å—Ä": "16:02", "–ú–∞–≥—Ä–∏–±": "19:00", "–ò—à–∞": "20:40"},
    "22-04-2025": {"–§–∞–¥–∂—Ä": "03:40", "–®—É—Ä—É–∫": "05:10", "–ó—É—Ö—Ä": "12:14", "–ê—Å—Ä": "16:03", "–ú–∞–≥—Ä–∏–±": "19:01", "–ò—à–∞": "20:41"},
    "23-04-2025": {"–§–∞–¥–∂—Ä": "03:39", "–®—É—Ä—É–∫": "05:09", "–ó—É—Ö—Ä": "12:14", "–ê—Å—Ä": "16:03", "–ú–∞–≥—Ä–∏–±": "19:03", "–ò—à–∞": "20:43"},
    "24-04-2025": {"–§–∞–¥–∂—Ä": "03:37", "–®—É—Ä—É–∫": "05:07", "–ó—É—Ö—Ä": "12:14", "–ê—Å—Ä": "16:03", "–ú–∞–≥—Ä–∏–±": "19:04", "–ò—à–∞": "20:44"},
    "25-04-2025": {"–§–∞–¥–∂—Ä": "03:36", "–®—É—Ä—É–∫": "05:06", "–ó—É—Ö—Ä": "12:14", "–ê—Å—Ä": "16:04", "–ú–∞–≥—Ä–∏–±": "19:05", "–ò—à–∞": "20:45"},
    "26-04-2025": {"–§–∞–¥–∂—Ä": "03:34", "–®—É—Ä—É–∫": "05:04", "–ó—É—Ö—Ä": "12:14", "–ê—Å—Ä": "16:04", "–ú–∞–≥—Ä–∏–±": "19:06", "–ò—à–∞": "20:46"},
    "27-04-2025": {"–§–∞–¥–∂—Ä": "03:33", "–®—É—Ä—É–∫": "05:03", "–ó—É—Ö—Ä": "12:13", "–ê—Å—Ä": "16:05", "–ú–∞–≥—Ä–∏–±": "19:07", "–ò—à–∞": "20:47"},
    "28-04-2025": {"–§–∞–¥–∂—Ä": "03:31", "–®—É—Ä—É–∫": "05:01", "–ó—É—Ö—Ä": "12:13", "–ê—Å—Ä": "16:05", "–ú–∞–≥—Ä–∏–±": "19:09", "–ò—à–∞": "20:49"},
    "29-04-2025": {"–§–∞–¥–∂—Ä": "03:29", "–®—É—Ä—É–∫": "05:00", "–ó—É—Ö—Ä": "12:13", "–ê—Å—Ä": "16:05", "–ú–∞–≥—Ä–∏–±": "19:10", "–ò—à–∞": "20:50"},
    "30-04-2025": {"–§–∞–¥–∂—Ä": "03:27", "–®—É—Ä—É–∫": "04:58", "–ó—É—Ö—Ä": "12:13", "–ê—Å—Ä": "16:06", "–ú–∞–≥—Ä–∏–±": "19:11", "–ò—à–∞": "20:51"},
}

# –í—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö –¥–æ –Ω–∞–º–∞–∑–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
NOTIFY_BEFORE_MINUTES = 10

# –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ú–°–ö
LOCAL_TIMEZONE = ZoneInfo("Europe/Moscow")

def get_local_now():
    return datetime.datetime.now(datetime.UTC).astimezone(LOCAL_TIMEZONE)

async def send_telegram_message(text: str):
    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
    async with aiohttp.ClientSession() as session:
        async with session.post(url, data={
            "chat_id": TELEGRAM_CHAT_ID,
            "text": text,
            "parse_mode": "HTML"
        }) as resp:
            if resp.status != 200:
                print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {resp.status}")
            else:
                print(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {text}")

async def schedule_notifications():
    await send_telegram_message("üïå Prayer tracker is running...")
    await send_telegram_message(f"<i>–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: {get_local_now().strftime('%H:%M:%S')}</i>")

    notified = set()

    while True:
        now = get_local_now()
        today_str = now.strftime("%d-%m-%Y")

        if today_str in PRAYER_TIMES:
            times = PRAYER_TIMES[today_str]
            for name, time_str in times.items():
                prayer_time = datetime.datetime.strptime(
                    f"{today_str} {time_str}", "%d-%m-%Y %H:%M"
                ).replace(tzinfo=LOCAL_TIMEZONE)

                notify_time = prayer_time - datetime.timedelta(minutes=NOTIFY_BEFORE_MINUTES)

                if notify_time <= now < prayer_time and (today_str, name) not in notified:
                    message = f"üìø –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: —Å–∫–æ—Ä–æ <b>{name}</b> ‚Äî –≤ <b>{time_str}</b>"
                    await send_telegram_message(message)
                    notified.add((today_str, name))

        await asyncio.sleep(30)

if __name__ == "__main__":
    asyncio.run(schedule_notifications())
